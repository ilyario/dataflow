apiVersion: v1
kind: Secret
metadata:
  name: nessie-credentials
  namespace: default
type: Opaque
stringData:
  nessieUrl: "http://nessie:19120/api/v2"
  branch: "main"
  namespace: "analytics"
  table: "stock_items"
  token: "your-auth-token"
---
apiVersion: v1
kind: Secret
metadata:
  name: s3-credentials
  namespace: default
type: Opaque
stringData:
  AWS_REGION: "us-east-1"
  AWS_ACCESS_KEY_ID: "admin"
  AWS_SECRET_ACCESS_KEY: "password"
  AWS_ENDPOINT_URL_S3: "http://minio:9000"
---
apiVersion: dataflow.dataflow.io/v1
kind: DataFlow
metadata:
  name: kafka-to-nessie-secrets
spec:
  source:
    type: kafka
    kafka:
      brokers:
        - localhost:9092
      topic: stock-topic
      consumerGroup: dataflow-nessie-group
  sink:
    type: nessie
    nessie:
      # Использование секретов для конфиденциальных данных
      nessieUrlSecretRef:
        name: nessie-credentials
        key: nessieUrl
      branchSecretRef:
        name: nessie-credentials
        key: branch
      namespaceSecretRef:
        name: nessie-credentials
        key: namespace
      tableSecretRef:
        name: nessie-credentials
        key: table
      tokenSecretRef:
        name: nessie-credentials
        key: token
      # AWS credentials для S3 backend
      awsRegionSecretRef:
        name: s3-credentials
        key: AWS_REGION
      awsAccessKeyIDSecretRef:
        name: s3-credentials
        key: AWS_ACCESS_KEY_ID
      awsSecretAccessKeySecretRef:
        name: s3-credentials
        key: AWS_SECRET_ACCESS_KEY
      awsEndpointURLSecretRef:
        name: s3-credentials
        key: AWS_ENDPOINT_URL_S3
      autoCreateTable: true
  transformations:
    - type: flatten
      flatten:
        field: rowsStock
    - type: timestamp
      timestamp:
        fieldName: created_at
