apiVersion: dataflow.dataflow.io/v1
kind: DataFlow
metadata:
  name: postgres-to-kafka-router
spec:
  source:
    type: postgresql
    postgresql:
      # Для локального запуска используйте localhost:5432
      # Для запуска в Kubernetes/Docker используйте postgres:5432
      connectionString: "postgres://dataflow:dataflow@localhost:5432/dataflow?sslmode=disable"
      table: events
      pollInterval: 5
  sink:
    type: kafka
    kafka:
      brokers:
        - localhost:9092
      topic: default-events
  transformations:
    - type: timestamp
      timestamp:
        fieldName: send_at
    - type: router
      router:
        routes:
          # Маршрутизация сообщений с type='order' в топик orders
          - condition: "$.type == 'order'"
            sink:
              type: kafka
              kafka:
                brokers:
                  - localhost:9092
                topic: orders
          # Маршрутизация сообщений с type='user' в топик users
          - condition: "$.type == 'user'"
            sink:
              type: kafka
              kafka:
                brokers:
                  - localhost:9092
                topic: users
          # Маршрутизация сообщений с type='payment' в топик payments
          - condition: "$.type == 'payment'"
            sink:
              type: kafka
              kafka:
                brokers:
                  - localhost:9092
                topic: payments

